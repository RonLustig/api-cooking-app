{% extends "cookapp/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <!-- Recipe Title Section -->
    <div class="recipe-header text-center py-3 mb-4" style="background-color: #f7f7f7; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: center; align-items: center;">
            <h1 class="display-4 font-weight-bold mb-3" style="color: #333; font-size: 2.5rem; margin: 0; display: inline;">{{ recipe.title }}</h1>
            
            <!-- Tags Section -->
            {% if recipe.tags %}
            <div class="tags-section" style="display: inline-block; margin-left: 20px;">
                {% for tag in recipe.tags %}
                <span class="badge badge-pill" style="background-color: #7eacb5; color: white; padding: 6px 12px; font-size: 13px; margin: 3px;">{{ tag }}</span>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Favorite Button -->
            {% if user.is_authenticated %}
            <form action="{% url 'toggle_favorite' recipe.id %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn-primary-favorite" style="position: absolute; top: 20px; right: 20px;">
                <strong>{% if is_favorited %}Remove from{% else %}Add to{% endif %} Favorites</strong>
                </button>
            </form>
            {% else %}
            <a href="{% url 'login' %}" class="btn-primary-favorite" style="position: absolute; top: 20px; right: 20px;">Log in to add to Favorites</a>
            {% endif %}
        </div>
        
        <!-- Recipe Image -->
        {% if recipe.image %}
            <img src="{{ recipe.image }}" alt="{{ recipe.title }}" class="img-fluid my-3" style="max-width: 60%; height: 500px; border-radius: 10px; box-shadow: 0 6px 10px rgba(0,0,0,0.15);">
        {% endif %}
    </div>
    

    <!-- Two-Column Layout for Ingredients and Instructions -->
    <div class="row">
        <!-- Ingredients Section -->
        <div class="col-md-6 mb-4">
            <div class="ingredients-section p-4" style="background-color: #fdfefe; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h3 class="font-weight-bold mb-3" style="color: #333; font-size: 1.6rem;">Ingredients</h3>
                <ul class="list-group list-group-flush">
                    {% for ingredient in recipe.ingredients.all %}
                        <li class="list-group-item" style="background-color: #d6eaf8; border: none; border-radius: 5px; margin-bottom: 8px;">
                            ðŸ¥• {{ ingredient.name }}
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <!-- Instructions Section -->
        <div class="col-md-6 mb-4">
            <div class="instructions-section p-4" style="background-color: #fdfefe; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h3 class="font-weight-bold mb-3" style="color: #333; font-size: 1.6rem;">Instructions</h3>
                <ol style="line-height: 1.7; color: #2c3e50;">
                    {% for instruction in instructions_list %}
                        <li style="margin-bottom: 8px; text-align: left;">{{ instruction }}</li>
                    {% endfor %}
                </ol>
            </div>
        </div>
    </div>
</div>


<!-- PDF Download Button at the bottom -->
<div class="text-center mt-4">
    <button id="pdfDownloader" class="btn btn-primary">Download Recipe as PDF</button>
</div>
</div>

<!-- Include jsPDF and html2canvas Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- JavaScript for PDF Download -->
<script>
    document.getElementById('pdfDownloader').addEventListener('click', function() {
        document.body.classList.add('pdf-mode');
    
        // Use html2canvas with specific options to ensure images are fully loaded and rendered
        html2canvas(document.querySelector('.container'), {
            allowTaint: true, // Enables cross-origin images to be captured
            useCORS: true,    // Ensures CORS-enabled images are rendered
            logging: true     // Logs process steps for debugging if needed
        }).then(function(canvas) {
            var imgData = canvas.toDataURL('image/png');
    
            // Initialize jsPDF correctly based on the library's version
            const { jsPDF } = window.jspdf;
            var doc = new jsPDF('p', 'mm', 'a4');
    
            // Page dimensions in mm
            var pageWidth = doc.internal.pageSize.width;
            var pageHeight = doc.internal.pageSize.height;
    
            // Calculate dimensions to fit the page while preserving aspect ratio
            var imgWidth = pageWidth;
            var imgHeight = canvas.height * imgWidth / canvas.width;
            if (imgHeight > pageHeight) {
                imgHeight = pageHeight;
                imgWidth = canvas.width * imgHeight / canvas.height;
            }
    
            // Add the image to the PDF
            doc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
            doc.save('{{ recipe.title }}.pdf');
    
            document.body.classList.remove('pdf-mode');
        }).catch(error => {
            console.error("Error generating PDF: ", error);
        });
    });
    </script>
{% endblock %}
